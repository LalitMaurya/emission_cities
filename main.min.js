/*! template 2017-07-05 */
function restoreUserZoom(){svg.call(mapTools.zoom).on("dblclick.zoom",null).call(mapTools.zoom.event)}function disableUserZoom(){svg.call(mapTools.zoom).on("dblclick.zoom",null).on("mousedown.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null).on("touchend.zoom",null).on("wheel.zoom",null).call(mapTools.zoom.event)}function cityCompare(a){cover.style("pointer-events","none"),app.currentCity=a,disableUserZoom(),clearMap(),chosenTip.direction("n").offset([-10,0]),comparedTip.direction("n").offset([-10,0]),comparedTip2.direction("n").offset([-10,0]),mapTools.tip.hide(),chosenG.style("opacity",1),pathG.style("opacity",1),d3.select("#details-txt").html("Summer highs in <span class='city-highlight'>"+a.city.replace(" ","&nbsp")+",&nbsp"+a.country.replace(" ","&nbsp")+"</span> could be more like <span class='city-highlight'>"+a.Compared85CityName.replace(" ","&nbsp")+",&nbsp;"+a.Compared85Country.replace(" ","&nbsp")+"</span> by 2100 without emissions cuts.");var b=mapProjection([a.longitude,a.latitude]),c=mapProjection([a.Compared85Longitude,a.Compared85Latitude]),d=(mapProjection([a.Compared45Longitude,a.Compared45Latitude]),[b,c]),e=[[9e3,9e3],[-9e3,-9e3]];linedata=[{x:d[0][0],y:d[0][1]},{x:d[1][0],y:d[1][1]}];var f=mapTools.getLineXYZ(d);mapTools.getLineXYZ(e);app.currentCityR=app.defaultActiveR/f[2],chosenCity=chosenG.append("circle").attr("class","active-city").attr("cx",function(a){return d[0][0]}).attr("cy",function(a){return d[0][1]}).attr("r",app.currentCityR),app.chosenCity=chosenCity,comparedG.style("opacity",0),comparedCity=comparedG.append("circle").attr("class","active-city high").attr("cx",function(a){return d[1][0]}).attr("cy",function(a){return d[1][1]}).attr("r",app.defaultCityR),app.comparedCity=comparedCity,cityPath=pathG.append("path").attr("class","connector high").attr("d",line(linedata)).style({"stroke-width":4/f[2]});var g=cityPath.node().getTotalLength();mapG.classed("future",!0),citiesG.style("opacity",1).transition().duration(500).style("opacity",0),setTimeout(function(){comparedG.transition().duration(100).style("opacity",1)},2e3),cityPath.attr("stroke-dasharray",g+" "+g).attr("stroke-dashoffset",g).transition().duration(2e3).ease("linear").attr("stroke-dashoffset",0).each("end",function(){var b=getTipPositions();"s"==b.chosen&&chosenTip.direction("s").offset([10,0]),"s"==b.compared1&&comparedTip.direction("s").offset([10,0]),"s"==b.compared2&&comparedTip2.direction("s").offset([10,0]),chosenTip.show(a,chosenCity[0][0]),comparedTip.show(a,comparedCity[0][0]),app.compareLevel=1}),mapTools.zoomXYZ(f,1750),chosenCity.transition().duration(1750).attr("r",app.currentCityR),comparedCity.transition().duration(1750).attr("r",app.currentCityR),setTimeout(function(){cover.style("pointer-events","all"),d3.select("#emissions-btn").style("opacity",0).style("visibility","visible").transition().duration(750).style("opacity",1).each("end",function(){var a=d3.select(this);a.style("opacity",null),a.on("click",emissionBtnListener)})},2e3)}function drawSecondLine(){pathG2.style("opacity",1),cover.style("pointer-events","none");for(var a=app.currentCity,b=mapProjection([a.longitude,a.latitude]),c=mapProjection([a.Compared85Longitude,a.Compared85Latitude]),d=mapProjection([a.Compared45Longitude,a.Compared45Latitude]),e=[b,d],f=[b,d,c],g=[[9e3,9e3],[-9e3,-9e3]],h=0;h<f.length;h++){var i=f[h];i[0]<g[0][0]&&(g[0][0]=i[0]),i[1]<g[0][1]&&(g[0][1]=i[1]),i[0]>g[1][0]&&(g[1][0]=i[0]),i[1]>g[1][1]&&(g[1][1]=i[1])}linedata2=[{x:e[0][0],y:e[0][1]},{x:e[1][0],y:e[1][1]}];var j=(mapTools.getLineXYZ(e),mapTools.getLineXYZ(g));app.currentCityR=app.defaultActiveR/j[2],comparedG2.style("opacity",0),comparedCity2=comparedG2.append("circle").attr("class","active-city low").attr("cx",function(a){return e[1][0]}).attr("cy",function(a){return e[1][1]}).attr("r",app.defaultCityR),app.comparedCity2=comparedCity2,cityPath2=pathG2.append("path").attr("class","connector low").attr("d",line(linedata2)).style({"stroke-width":4/j[2]});var k=(cityPath.node().getTotalLength(),cityPath2.node().getTotalLength());pathG.classed("greyed",!0),comparedG.classed("greyed",!0),d3.select("#comparedTip").classed("greyed",!0),setTimeout(function(){comparedG2.transition().duration(100).style("opacity",1)},2e3),cityPath2.attr("stroke-dasharray",k+" "+k).attr("stroke-dashoffset",k).transition().duration(2e3).ease("linear").attr("stroke-dashoffset",0).each("end",function(){var a=getTipPositions();"s"==a.chosen&&chosenTip.direction("s").offset([10,0]),"s"==a.compared1&&comparedTip.direction("s").offset([10,0]),"s"==a.compared2&&comparedTip2.direction("s").offset([10,0]),chosenTip.show(app.currentCity,chosenCity[0][0]),comparedTip.show(app.currentCity,comparedCity[0][0]),comparedTip2.show(app.currentCity,comparedCity2[0][0]),app.compareLevel=2}),mapTools.zoomXYZ(j,1750),cityPath.transition().style({"stroke-width":4/j[2]}),chosenCity.transition().duration(1750).attr("r",app.currentCityR),comparedCity.transition().duration(1750).attr("r",app.currentCityR),comparedCity2.transition().duration(1750).attr("r",app.currentCityR),setTimeout(function(){cover.style("pointer-events","all")},2e3)}function returnTOEarth(){cover.style("pointer-events","none");var a=app.currentCity;disableUserZoom(),clearMap(),app.modalReady=!0,mapTools.tip.hide(),chosenG.style("opacity",1),pathG.style("opacity",1),d3.select("#details-txt").html("Summer highs in <span class='city-highlight'>"+a.city.replace(" ","&nbsp")+",&nbsp"+a.country.replace(" ","&nbsp")+"</span> could be more like <span class='city-highlight'>"+a.Compared85CityName.replace(" ","&nbsp")+",&nbsp;"+a.Compared85Country.replace(" ","&nbsp")+"</span> by 2100 without emissions cuts.");for(var b=mapProjection([a.longitude,a.latitude]),c=(mapProjection([a.Compared85Longitude,a.Compared85Latitude]),mapProjection([a.Compared45Longitude,a.Compared45Latitude])),d=[b,c],e=[[9e3,9e3],[-9e3,-9e3]],f=0;f<d.length;f++){var g=d[f];g[0]<e[0][0]&&(e[0][0]=g[0]),g[1]<e[0][1]&&(e[0][1]=g[1]),g[0]>e[1][0]&&(e[1][0]=g[0]),g[1]>e[1][1]&&(e[1][1]=g[1])}linedata2=[{x:d[0][0],y:d[0][1]},{x:d[1][0],y:d[1][1]}];var h=mapTools.getLineXYZ(d),i=mapTools.getLineXYZ(e);app.currentCityR=app.defaultActiveR/h[2],chosenCity=chosenG.append("circle").attr("class","active-city").attr("cx",function(a){return d[0][0]}).attr("cy",function(a){return d[0][1]}).attr("r",app.currentCityR),app.chosenCity=chosenCity,comparedG2.style("opacity",0),comparedCity2=comparedG2.append("circle").attr("class","active-city low").attr("cx",function(a){return d[1][0]}).attr("cy",function(a){return d[1][1]}).attr("r",app.defaultCityR),app.comparedCity2=comparedCity2,cityPath2=pathG2.append("path").attr("class","connector low").attr("d",line(linedata2)).style({"stroke-width":4/i[2]});var j=cityPath2.node().getTotalLength();citiesG.style("opacity",1).transition().duration(500).style("opacity",0),setTimeout(function(){comparedG2.transition().duration(100).style("opacity",1)},2e3),cityPath2.attr("stroke-dasharray",j+" "+j).attr("stroke-dashoffset",j).transition().duration(2e3).ease("linear").attr("stroke-dashoffset",0).each("end",function(){var a=getTipPositions();"s"==a.chosen&&chosenTip.direction("s").offset([10,0]),"s"==a.compared1&&comparedTip.direction("s").offset([10,0]),"s"==a.compared2&&comparedTip2.direction("s").offset([10,0]),chosenTip.show(app.currentCity,chosenCity[0][0]),comparedTip2.show(app.currentCity,comparedCity2[0][0]),app.compareLevel=2}),mapTools.zoomXYZ(i,1750),chosenCity.transition().duration(1750).attr("r",app.currentCityR),comparedCity2.transition().duration(1750).attr("r",app.currentCityR),setTimeout(function(){cover.style("pointer-events","all")},2e3)}function restore(){$("input#autocomplete").val(""),mapG.classed("future",!1),app.compareLevel=0,app.offWorld=!1,app.modalReady=!1,app.currentCity=d3.select(null),app.returned=!1,d3.select("#details-txt").text("Search or click on a city to find out."),chosenTip.hide(),comparedTip.hide(),comparedTip2.hide(),pathG.classed("greyed",!1),comparedG.classed("greyed",!1),d3.select("#comparedTip").classed("greyed",!1),cover.style("pointer-events","none"),d3.selectAll("#emissions-btn").style("visibility","hidden").classed("active",!1).on("click",null),d3.selectAll("#emissions-btn .inner-cell").text("But what about with moderate emissions cuts?"),app.currentCityR=app.defaultCityR/vis.continentalXYZ[2],mapTools.zoomXYZ(vis.continentalXYZ,750),pathG.transition().duration(750).style("opacity",0).each("end",function(){cityPath.remove()}),pathG2.transition().duration(750).style("opacity",0).each("end",function(){cityPath2.remove(),pathG2.style("opacity",1)}),comparedG.transition().duration(750).style("opacity",0).each("end",function(){comparedCity.remove()}),comparedG2.transition().duration(750).style("opacity",0).each("end",function(){comparedCity2.remove()}),chosenG.transition().duration(750).style("opacity",0).each("end",function(){chosenCity.remove()}),citiesG.transition().delay(500).duration(500).style("opacity",1),d3.select("#emissions-btn .inner-cell").text("But what about with moderate emissions cuts?"),restoreUserZoom()}function clearMap(){app.compareLevel>0&&(chosenTip.hide(),comparedTip.hide(),comparedTip2.hide(),chosenCity.remove(),comparedCity.remove(),comparedCity2.remove(),cityPath.remove(),cityPath2.remove())}function emissionBtnListener(){ga("send","event",analyticsId,"emissionsButtonClick");var a=d3.select(this);a.classed("active");chosenTip.hide(),comparedTip.hide(),comparedTip2.hide(),app.offWorld?(hideVideo(),app.returnTo?(returnTOEarth(),d3.select("#details-txt").html("Summer highs in <span class='city-highlight'>"+app.currentCity.city.replace(" ","&nbsp")+",&nbsp"+app.currentCity.country.replace(" ","&nbsp")+"</span> could be more like <span class='city-highlight'>"+app.currentCity.Compared45CityName.replace(" ","&nbsp")+",&nbsp;"+app.currentCity.Compared45Country.replace(" ","&nbsp")+"</span> by 2100 with moderate emissions cuts."),d3.select("#emissions-btn .inner-cell").text("What are moderate emissions cuts?"),app.returnTo=!1,app.offWorld=!1,app.returned=!0):app.modalReady?(console.log("should modal"),openModal()):(app.secondPlay=!0,showVideo(app.currentCity),app.modalReady=!0,app.secondPlay=!1,d3.select("#emissions-btn .inner-cell").text("What are moderate emissions cuts?"))):app.compareLevel>1?openModal():(drawSecondLine(),d3.select("#emissions-btn .inner-cell").text("What are moderate emissions cuts?"),d3.select("#details-txt").html("Summer highs in <span class='city-highlight'>"+app.currentCity.city.replace(" ","&nbsp")+",&nbsp"+app.currentCity.country.replace(" ","&nbsp")+"</span> could be more like <span class='city-highlight'>"+app.currentCity.Compared45CityName.replace(" ","&nbsp")+",&nbsp;"+app.currentCity.Compared45Country.replace(" ","&nbsp")+"</span> by 2100 with moderate emissions cuts."))}function prepTypeAhead(){$("#autocomplete").typeahead({hint:!0,highlight:!0,minLength:1},{name:"cities",source:substringMatcher(dataStore.cityNames)}).on("typeahead:selected",function(a,b){chosenTip.hide(),comparedTip.hide(),comparedTip2.hide(),pathG.classed("greyed",!1),comparedG.classed("greyed",!1),d3.select("#comparedTip").classed("greyed",!1),app.returned=!1,app.offWorld&&(hideVideo(),app.compareLevel=0);var c=b.split(", "),d=dataStore.cities.find(function(a){return a.city==c[0]&&a.country==c[1]});ga("send","event",analyticsId,"citySearch",b),0===+d.OffEarth?cityCompare(d):showVideo(d)}).on("typeahead:autocompleted",function(a,b){chosenTip.hide(),comparedTip.hide(),comparedTip2.hide(),pathG.classed("greyed",!1),comparedG.classed("greyed",!1),d3.select("#comparedTip").classed("greyed",!1),app.returned=!1,app.offWorld&&(hideVideo(),app.compareLevel=0);var c=b.split(", "),d=dataStore.cities.find(function(a){return a.city==c[0]&&a.country==c[1]});d3.select(".tt-menu").classed("tt-open",!1).style("display","none"),ga("send","event",analyticsId,"citySearch",b),0===+d.OffEarth?cityCompare(d):showVideo(d)})}function openModal(){d3.select("#modal-cover").style("visibility","visible").on("click",closeModal),d3.select("#modal").style("visibility","visible").on("click",closeModal)}function closeModal(){console.log("close modal"),d3.select("#modal-cover").style("visibility","hidden").on("click",null),d3.select("#modal").style("visibility","hidden").on("click",null),restore()}function loadWarming(){d3.json("warming.topo.json",function(a,b){var c=topojson.feature(b,b.objects.warming).features;dataStore.warming=c,drawWarming(c)})}function drawWarming(a){vis.warming=warmingG.selectAll("path").data(a).enter().append("path").attr("id",function(a){return"warming"+a.id}).attr("class","warming").attr("d",mapPath)}function tooltipAdjust(){app.compareLevel>0&&(chosenTip.style("opacity",0),comparedTip.style("opacity",0),chosenTip.show(app.currentCity,app.chosenCity[0][0]),comparedTip.show(app.currentCity,app.comparedCity[0][0]),chosenTip.style("opacity",1),comparedTip.style("opacity",1)),app.compareLevel>1&&(comparedTip2.style("opacity",0),comparedTip2.show(app.currentCity,app.comparedCity2[0][0]),comparedTip2.style("opacity",1))}function zoomControlListener(){var a=d3.select(this),b=a.classed("plus"),c=mapTools.getCurrentXYZ(),d=Math.round10(c[2],-1);b?c[2]=1.5*d:d>1.5?c[2]=.66*d:d>1&&(c[2]=1),mapTools.zoomXYZ(c)}function showEmbedOverlay(){d3.selectAll(".d3-tip").style("visibility","hidden"),d3.select("#embed-cover").classed("active",!0),d3.select("#embed-overlay").classed("active",!0),ga("send","event",analyticsId,"getEmbedCode")}function hideEmbedOverlay(){d3.select("#embed-cover").classed("active",!1),d3.select("#embed-overlay").classed("active",!1),d3.selectAll(".d3-tip").style("visibility","visible")}function toggleTemps(){ga("send","event",analyticsId,"TempToggle");var a=d3.select(".temp-slider"),b=a.classed("right");if(a.classed("right",!b),b){if(chosenTip.html(function(a){var b=Math.round10(a.temperature,-1);return b%1===0&&(b+=".0"),a.city+",<br>"+a.country+"<br><span class='num'>"+b+"°C</span>"}),comparedTip.html(function(a){var b=Math.round10(a.Compared85Temperature,-1);return b%1===0&&(b+=".0"),a.Compared85CityName+",<br>"+a.Compared85Country+"<br><span class='num'>"+b+"°C</span>"}),comparedTip2.html(function(a){var b=Math.round10(a.Compared45Temperature,-1);return b%1===0&&(b+=".0"),a.Compared45CityName+",<br>"+a.Compared45Country+"<br><span class='num'>"+b+"°C</span>"}),app.offWorld){var c,d=Math.round10(app.currentCity.Projected85Temperature,-1);d=Math.round10(d,-1),d%1===0&&(d+=".0"),c=d+"°C",d3.select("#video-temp").text(c)}}else if(chosenTip.html(function(a){var b=9*a.temperature/5+32;return b=Math.round10(b,-1),b%1===0&&(b+=".0"),a.city+",<br>"+a.country+"<br><span class='num'>"+b+"°F</span>"}),comparedTip.html(function(a){var b=9*a.Compared85Temperature/5+32;b=Math.round10(b,-1),b%1===0&&(b+=".0");var c=a.Compared85CityName+",<br>"+a.Compared85Country+"<br><span class='num'>"+b+"°F</span>";return c}),comparedTip2.html(function(a){var b=9*a.Compared45Temperature/5+32;return b=Math.round10(b,-1),b%1===0&&(b+=".0"),a.Compared45CityName+",<br>"+a.Compared45Country+"<br><span class='num'>"+b+"°F</span>"}),app.offWorld){var c,d=9*app.currentCity.Projected85Temperature/5+32;d=Math.round10(d,-1),d%1===0&&(d+=".0"),c=d+"°F",d3.select("#video-temp").text(c)}if(!app.offWorld){var e=getTipPositions();"s"==e.chosen&&chosenTip.direction("s").offset([10,0]),"s"==e.compared1&&comparedTip.direction("s").offset([10,0]),"s"==e.compared2&&comparedTip2.direction("s").offset([10,0]),app.returned?(chosenTip.show(app.currentCity,chosenCity[0][0]),comparedTip2.show(app.currentCity,comparedCity2[0][0])):(app.compareLevel>0&&(chosenTip.show(app.currentCity,chosenCity[0][0]),comparedTip.show(app.currentCity,comparedCity[0][0])),app.compareLevel>1&&comparedTip2.show(app.currentCity,comparedCity2[0][0]))}}function showVideo(a){app.offWorld=!0,d3.select(".map-restore").classed("over-vid",!0),1===+a.OffEarth&&(console.log("offEarth 1"),d3.selectAll("#emissions-btn .inner-cell").text("But what about with moderate emissions cuts?"),app.returnTo=!0),app.currentCity=a,mapTools.tip.hide();var b,c=d3.select(".temp-slider").classed("right");if(app.secondPlay?(d3.select("#emissions-btn .inner-cell").text("What are moderate emissions cuts?"),b=a.Projected45Temperature):b=a.Projected85Temperature,c){var d;b=9*b/5+32,b=Math.round10(b,-1),d=b+"°F",d3.select("#video-temp").text(d)}else{var d;b=Math.round10(b,-1),d=b+"°C",d3.select("#video-temp").text(d)}d3.select("#video-temp").text(d),app.secondPlay?d3.select("#details-txt").html("Currently, there is no place on Earth that is as hot as summers could be in <span class='city-highlight'>"+a.city.replace(" ","&nbsp")+",&nbsp"+a.country.replace(" ","&nbsp")+"</span> by 2100 even with moderate emissions cuts."):d3.select("#details-txt").html("Currently, there is no place on Earth that is as hot as summers could be in <span class='city-highlight'>"+a.city.replace(" ","&nbsp")+",&nbsp"+a.country.replace(" ","&nbsp")+"</span> by 2100 without emissions cuts."),d3.select("#video-cover").style("visibility","visible"),d3.select("#video-cover video")[0][0].play(),d3.select("#emissions-btn").style("opacity",0).style("visibility","visible").transition().duration(750).style("opacity",1).each("end",function(){var a=d3.select(this);a.style("opacity",null),a.on("click",emissionBtnListener)})}function hideVideo(){d3.select("#video-cover video")[0][0].pause(),d3.select("#video-cover").style("visibility","hidden"),d3.select(".map-restore").classed("over-vid",!1),app.compareLevel=0}function getTipPositions(){var a=app.currentCity,b=+a.latitude,c=+a.Compared85Latitude,d=+a.Compared45Latitude,e={chosen:"n",compared1:"n",compared2:"n"};return b>c?e.chosen="s":e.compared1="s",d>b&&(e.compared2="s"),e}function decimalAdjust(a,b,c){return"undefined"==typeof c||0===+c?Math[a](b):(b=+b,c=+c,isNaN(b)||"number"!=typeof c||c%1!==0?NaN:(b=b.toString().split("e"),b=Math[a](+(b[0]+"e"+(b[1]?+b[1]-c:-c))),b=b.toString().split("e"),+(b[0]+"e"+(b[1]?+b[1]+c:c))))}function dataLoaded(a,b){dataStore.mapData2=b[0],dataStore.cities=b[2],mapTools.drawMap(b),mapFunctionsDefined&&mapFunctions.afterMapLoad&&mapFunctions.afterMapLoad()}function stopped(){d3.event.defaultPrevented&&d3.event.stopPropagation()}var app={currentCity:d3.select(null),scenario:"85",defaultCityR:3,defaultActiveR:5,chosenCity:d3.select(null),comparedCity:d3.select(null),comparedCity2:d3.select(null),compareLevel:0,offWorld:!1,returnTo:!1,returned:!1,modalReady:!1,secondPlay:!1},dataStore=dataStore||{},mapFunctions=mapFunctions||{},ui=ui||{},analyticsId="global-shifting-cities-2017",chosenCity=d3.select(null),cityPath=d3.select(null),cityPath2=d3.select(null),comparedCity=d3.select(null);comparedCity2=d3.select(null),mapFunctions.citySelect=function(a){var b=a.city+", "+a.country;ga("send","event",analyticsId,"cityClicked",b),$("input#autocomplete").val(""),0===+a.OffEarth?cityCompare(a):showVideo(a)},mapFunctions.afterMapLoad=function(){console.log("after map load"),restoreUserZoom(),cover=svg.append("rect").attr("id","cover").attr("x","0").attr("y","0").attr("width",vis.mapWidth).attr("height",vis.mapHeight).style({fill:"none","pointer-events":"none"}).on("click",restore)},line=d3.svg.line().x(function(a){return a.x}).y(function(a){return a.y}),d3.selectAll(".bar-button").on("click",function(){var a=d3.select(this);a.classed("active")||(d3.select(".bar-button.active").classed("active",!1),a.classed("active",!0),app.scenario=a.attr("scenario"),console.log(app.scenario))});var substringMatcher=function(a){return function(b,c){var d;d=[],substrRegex=new RegExp(b,"i"),$.each(a,function(a,b){substrRegex.test(b)&&d.push(b)}),c(d)}};d3.select("#info-icon").on("click",function(){openModal(),chosenTip.hide(),comparedTip.hide(),comparedTip2.hide(),ga("send","event",analyticsId,"infoIcon")});var embedTemplate=$("#embed-template").html(),embedTemplateScript=Handlebars.compile(embedTemplate),embedContext={width:720,height:571};d3.select("#org-name").on("input",function(){var a=this.value;d3.select("textarea").style("visibility","visible");""==a?embedContext.org="ext":embedContext.org=a.split(" ").join("-"),embedHtml=embedTemplateScript(embedContext),$("#embed-overlay textarea").html(embedHtml)}),d3.selectAll("input[name='size']").on("change",function(){var a=this.value.split("x"),b=d3.select("#org-name")[0][0].value;embedContext.width=a[0],embedContext.height=a[1],""==b?embedContext.org="ext":embedContext.org=b.split(" ").join("-"),embedHtml=embedTemplateScript(embedContext),$("#embed-overlay textarea").html(embedHtml)}),d3.select("#temp-toggle").on("click",toggleTemps),d3.select(".map-restore").on("click",function(){d3.select(".map-restore").classed("over-vid",!1),hideVideo(),restore()}),d3.selectAll(".control-btn").on("click",zoomControlListener),d3.select("#embed-text").on("click",showEmbedOverlay),d3.select("#embed-cover").on("click",hideEmbedOverlay),d3.select("#embed-x").on("click",hideEmbedOverlay),d3.select("#cclogo").on("click",function(){ga("send","event",analyticsId,"CCLogoClick"),window.open("http://www.climatecentral.org","_blank")}),d3.select("#wmologo").on("click",function(){ga("send","event",analyticsId,"WMOLogoClick"),window.open("http://public.wmo.int/","_blank")}),Math.round10||(Math.round10=function(a,b){return decimalAdjust("round",a,b)});var mapFunctionsDefined="undefined"!=typeof mapFunctions,vis=new function(){this.windowHeight=Math.max(document.documentElement.clientHeight,window.innerHeight||0),this.windowWidth=Math.max(document.documentElement.clientWidth,window.innerWidth||0),this.container=d3.select("#map-container"),this.mapHeight=this.container.node().clientHeight,this.mapWidthPercentage=1,this.mapWidth=this.container.node().clientWidth*this.mapWidthPercentage,this.mapTools=mapTools,this.stateBounds=[],this.worldBounds=[[9e3,9e3],[-9e3,-9e3]],this.worldCitiesBounds=[[9e3,9e3],[-9e3,-9e3]],this.cityR=3.5,this.mapColors=["rgb(181, 226, 255)","rgb(136, 197, 255)","rgb(60, 119, 224)","rgb(39, 76, 143)","rgb(20, 48, 73)"]},mapTools=new function(){var a=this;this.zoomed=function(){mapG.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),mapG.selectAll(".mesh").style("stroke-width",1/d3.event.scale+"px"),citiesG.selectAll(".city").attr("r",4/d3.event.scale),tooltipAdjust()},this.zoom=d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([1,20]).on("zoom",a.zoomed),this.zoomTo=function(b,c){var d=mapPath.bounds(b),e=a.getBoundsXYZ(d);a.zoomXYZ(e,c)},this.zoomXYZ=function(b,c){c=parseInt(c)||1e3;var d=[vis.mapWidth/2-b[2]*b[0],vis.mapHeight/2-b[2]*b[1]];mapG.transition().duration(c).call(a.zoom.translate(d).scale(b[2]).event).style("stroke-width",1/b[2]+"px")},this.getBoundsXYZ=function(a){var b=(a[1][0]-a[0][0])/vis.mapWidth,c=(a[1][1]-a[0][1])/vis.mapHeight,d=.8/Math.max(b,c),e=(a[1][0]+a[0][0])/2,f=(a[1][1]+a[0][1])/2;return[e,f,d]},this.getXYZ=function(b){var c=mapPath.bounds(b);return a.getBoundsXYZ(c)},this.getCurrentXYZ=function(){var a=mapTools.zoom.translate(),b=mapTools.zoom.scale(),c=vis.mapWidth/2,d=c-a[0],e=d/b,f=vis.mapHeight/2,g=f-a[1],h=g/b;return[e,h,b]},this.getLineXYZ=function(a){var b=Math.abs((a[1][0]-a[0][0])/vis.mapWidth),c=Math.abs((a[1][1]-a[0][1])/vis.mapHeight),d=.8/Math.max(b,c),e=(a[1][0]+a[0][0])/2,f=(a[1][1]+a[0][1])/2;return[e,f,d]},this.getContinentalXYZ=function(a){var b=Math.abs((a[1][0]-a[0][0])/vis.mapWidth),c=Math.abs((a[1][1]-a[0][1])/vis.mapHeight),d=.98/Math.max(b,c),e=Math.abs(a[1][0]+a[0][0])/2,f=Math.abs(a[1][1]+a[0][1])/2;return[e,f,d]},this.getWorldXYZ=function(a){var b=Math.abs((a[1][0]-a[0][0])/vis.mapWidth),c=Math.abs((a[1][1]-a[0][1])/vis.mapHeight),d=1/Math.max(b,c),e=Math.abs(a[1][0]+a[0][0])/2,f=Math.abs(a[1][1]+a[0][1])/2;return[e,f,d]},this.resetMapObject=function(a){app["current"+a].classed("selected",!1),app["current"+a]=d3.select(null)},this.reset=function(){a.zoomXYZ(vis.continentalXYZ,750)},this.regionZoom=function(b){var c=d3.min(b,function(a){return a[0][0]}),d=d3.max(b,function(a){return a[1][0]}),e=d3.min(b,function(a){return a[0][1]}),f=d3.max(b,function(a){return a[1][1]}),g=[[c,e],[d,f]],h=this.getBoundsXYZ(g);a.zoomXYZ(h)},this.stateClick=function(b){app.currentState.node()===this?(a.resetMapObject("State"),mapFunctionsDefined&&"undefined"!=typeof mapFunctions.stateDeselect&&mapFunctions.stateDeselect(b)):(app.currentState=d3.select(this),app.currentState.classed("selected",!0),mapFunctionsDefined&&"undefined"!=typeof mapFunctions.stateSelect&&mapFunctions.stateSelect(b))},this.stateMouseover=function(a){d3.select(this).classed("hovered",!0),mapFunctionsDefined&&"undefined"!=typeof mapFunctions.stateMouseover&&mapFunctions.stateMouseover(a)},this.stateMouseout=function(a){d3.select(this).classed("hovered",!1),mapFunctionsDefined&&"undefined"!=typeof mapFunctions.stateMouseout&&mapFunctions.stateMouseout(a)},this.cityClick=function(b){app.currentCity.node()===this?(a.resetMapObject("City"),mapFunctionsDefined&&"undefined"!=typeof mapFunctions.cityDeselect&&mapFunctions.cityDeselect(b)):(app.currentCity=d3.select(this),app.currentCity.classed("selected",!0),mapFunctionsDefined&&"undefined"!=typeof mapFunctions.citySelect&&mapFunctions.citySelect(b))},this.drawMap=function(b){console.log("drawMap start");var c=b[0],d=b[1],e=b[2],f=topojson.feature(d,d.objects.borders).features,g=e.length,h=[];console.log("drawMap initial vars decalred");for(var i=0;g>i;i++)h.push(e[i].city+", "+e[i].country);dataStore.cityNames=h,console.log("cityNames preped"),prepTypeAhead(),console.log("typeAhead preped");var j=topojson.feature(c,c.objects.countries).features,k=j.length;for(i=0;k>i;i++){var l=mapPath.bounds(j[i]);l[0][0]<vis.worldBounds[0][0]&&(vis.worldBounds[0][0]=l[0][0]),l[0][1]<vis.worldBounds[0][1]&&(vis.worldBounds[0][1]=l[0][1]),l[1][0]>vis.worldBounds[1][0]&&(vis.worldBounds[1][0]=l[1][0]),l[1][1]>vis.worldBounds[1][1]&&(vis.worldBounds[1][1]=l[1][1])}var m=e.length;for(i=0;m>i;i++){var n=e[i],o=mapProjection([n.longitude,n.latitude]);o[0]<vis.worldCitiesBounds[0][0]&&(vis.worldCitiesBounds[0][0]=o[0]),o[1]<vis.worldCitiesBounds[0][1]&&(vis.worldCitiesBounds[0][1]=o[1]),o[0]>vis.worldCitiesBounds[1][0]&&(vis.worldCitiesBounds[1][0]=o[0]),o[1]>vis.worldCitiesBounds[1][1]&&(vis.worldCitiesBounds[1][1]=o[1])}vis.continentalXYZ=mapTools.getWorldXYZ(vis.worldBounds),vis.citiesXYZ=mapTools.getContinentalXYZ(vis.worldCitiesBounds),countries=countriesG.selectAll("path").data(j).enter().append("path").attr("id",function(a){return a.properties.abbr}).attr("class","state").attr("d",mapPath).attr("fill",function(a){if(void 0!==dataStore.mapColors&&void 0!==dataStore.mapColors[a.id]){var b=dataStore.mapColors[a.id].bucket;return 0===b?"none":colorScale(b)}}),borders=countriesG.selectAll(".mesh").data(f).enter().append("path").attr("class",function(a){return 1===a.properties.BDY_TYPE?"mesh":"mesh dotted"}).attr("d",mapPath),a.plotCities(e),mapTools.zoomXYZ(vis.citiesXYZ,0)},this.plotCities=function(a){citiesG.selectAll("none").data(a).enter().append("circle").attr("class",function(a){var b=a.temperature,c="city ";return c+=23>b?"b0":26>b?"b1":29>b?"b2":32>b?"b3":35>b?"b4":"b5"}).attr("id",function(a){return a.city.replace(" ","-")}).attr("cx",function(a){return mapProjection([a.longitude,a.latitude])[0]}).attr("cy",function(a){return mapProjection([a.longitude,a.latitude])[1]}).attr("r",vis.cityR).on("click",mapTools.cityClick).on("mouseover",mapTools.tip.show).on("mouseout",mapTools.tip.hide),mapG.call(mapTools.tip)},this.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){return a.city})},colorScale=d3.scale.quantize().range(vis.mapColors).domain([1,2,3,4,5]),mapProjection=d3.geo.equirectangular().center([0,0]).rotate([-12,0]).translate([vis.mapWidth/2,vis.mapHeight/2]),mapPath=d3.geo.path().projection(mapProjection),svg=d3.select("#map-container").append("svg").attr("width",vis.mapWidth).attr("height",vis.mapHeight).attr("id","map-svg").on("click",stopped,!0);svg.append("rect").attr("width",vis.mapWidth).attr("height",vis.mapHeight).attr("class","background");var mapG=svg.append("g").attr("id","map-g"),countriesG=mapG.append("g").attr("id","countries-g"),warmingG=mapG.append("g").attr("id","warming-g");pathG=mapG.append("g").attr("id","path-g"),pathG2=mapG.append("g").attr("id","path-g2"),citiesG=mapG.append("g").attr("id","cities-g"),chosenG=mapG.append("g").attr("id","chosen-g"),comparedG=mapG.append("g").attr("id","compare-g"),comparedG2=mapG.append("g").attr("id","compare-g2"),d3.queue().defer(d3.json,"countries2.topo.json").defer(d3.json,"borders.topo.json").defer(d3.csv,"match_table_flag.csv").awaitAll(dataLoaded),chosenTip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){var b=Math.round10(a.temperature,-1);return b%1===0&&(b+=".0"),a.city+",<br>"+a.country+"<br><span class='num'>"+b+"°C</span>"}),comparedTip=d3.tip().attr("class","d3-tip").attr("id","comparedTip").offset([-10,0]).html(function(a){var b=Math.round10(a.Compared85Temperature,-1);return b%1===0&&(b+=".0"),a.Compared85CityName+",<br>"+a.Compared85Country+"<br><span class='num'>"+b+"°C</span>"}),comparedTip2=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a){var b=Math.round10(a.Compared45Temperature,-1);return b%1===0&&(b+=".0"),a.Compared45CityName+",<br>"+a.Compared45Country+"<br><span class='num'>"+b+"°C</span>"}),chosenG.call(chosenTip),comparedG.call(comparedTip),comparedG2.call(comparedTip2),testObj={present:!0};